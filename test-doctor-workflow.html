<!DOCTYPE html>
<html>
<head>
    <title>Doctor Workflow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; max-width: 1000px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .console { background: #000; color: #0f0; padding: 10px; border-radius: 4px; font-family: monospace; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Doctor Workflow Test</h1>
    
    <div class="step info">
        <h2>üîß Test Workflow</h2>
        <p><strong>1. Doctor Login:</strong> bienaimee@gmail.com / password123</p>
        <p><strong>2. Get Patient List:</strong> Fetch all patients from database</p>
        <p><strong>3. Request Access:</strong> Click "View Patient Passport" to request permission</p>
        <p><strong>4. Patient Approval:</strong> Patient can approve/deny the request</p>
    </div>
    
    <div class="step">
        <h2>Step 1: Doctor Login</h2>
        <button onclick="testDoctorLogin()">Test Doctor Login</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="step">
        <h2>Step 2: Get Patient List</h2>
        <button onclick="testGetPatients()" id="patientsBtn" disabled>Get Patients</button>
        <div id="patientsResult"></div>
    </div>
    
    <div class="step">
        <h2>Step 3: Test Access Request</h2>
        <button onclick="testAccessRequest()" id="accessBtn" disabled>Test Access Request</button>
        <div id="accessResult"></div>
    </div>
    
    <div class="step">
        <h2>Step 4: Check Access Status</h2>
        <button onclick="testCheckAccess()" id="checkBtn" disabled>Check Access Status</button>
        <div id="checkResult"></div>
    </div>
    
    <h3>Console Output:</h3>
    <div id="console" class="console"></div>

    <script>
        let authToken = null;
        let patientId = null;
        const API_BASE = 'http://localhost:5000/api';
        
        const consoleDiv = document.getElementById('console');
        
        function log(message) {
            console.log(message);
            consoleDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + JSON.stringify(message, null, 2) + '\n';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        async function testDoctorLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = 'Testing doctor login...';
            
            try {
                log('Testing doctor login...');
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'bienaimee@gmail.com',
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                log('Login response:', data);
                
                if (response.ok && data.success) {
                    authToken = data.data.token;
                    resultDiv.className = 'step success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Doctor Login Successful!</h3>
                        <p><strong>User:</strong> ${data.data.user.name}</p>
                        <p><strong>Role:</strong> ${data.data.user.role}</p>
                        <p><strong>Token:</strong> ${authToken ? 'Present' : 'Missing'}</p>
                    `;
                    
                    // Enable next step
                    document.getElementById('patientsBtn').disabled = false;
                    log('Doctor login successful, token saved');
                } else {
                    resultDiv.className = 'step error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå Doctor Login Failed</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Message:</strong> ${data.message || 'Unknown error'}</p>
                    `;
                    log('Doctor login failed');
                }
            } catch (error) {
                resultDiv.className = 'step error';
                resultDiv.innerHTML = `<h3>‚ùå Login Error</h3><p>${error.message}</p>`;
                log('Login error:', error);
            }
        }
        
        async function testGetPatients() {
            const resultDiv = document.getElementById('patientsResult');
            resultDiv.innerHTML = 'Fetching patients...';
            
            try {
                log('Fetching patients...');
                
                const response = await fetch(`${API_BASE}/patients`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                log('Patients response:', data);
                
                if (response.ok && data.success) {
                    const patients = data.data;
                    patientId = patients.length > 0 ? patients[0]._id : null;
                    
                    resultDiv.className = 'step success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Patients Retrieved!</h3>
                        <p><strong>Count:</strong> ${patients.length}</p>
                        ${patients.length > 0 ? `<p><strong>First Patient:</strong> ${patients[0].user.name} (ID: ${patients[0]._id})</p>` : ''}
                    `;
                    
                    // Enable next steps
                    document.getElementById('accessBtn').disabled = false;
                    document.getElementById('checkBtn').disabled = false;
                    log('Patients retrieved successfully');
                } else {
                    resultDiv.className = 'step error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå Failed to Get Patients</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Message:</strong> ${data.message || 'Unknown error'}</p>
                    `;
                    log('Failed to get patients');
                }
            } catch (error) {
                resultDiv.className = 'step error';
                resultDiv.innerHTML = `<h3>‚ùå Error</h3><p>${error.message}</p>`;
                log('Error fetching patients:', error);
            }
        }
        
        async function testAccessRequest() {
            if (!patientId) {
                alert('No patient ID available. Please get patients first.');
                return;
            }
            
            const resultDiv = document.getElementById('accessResult');
            resultDiv.innerHTML = 'Testing access request...';
            
            try {
                log('Testing access request for patient:', patientId);
                
                const response = await fetch(`${API_BASE}/access-control/request`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        patientId: patientId,
                        hospitalId: '68e42c3f7987fd304342bd9d',
                        requestType: 'view',
                        reason: 'Testing doctor access request workflow',
                        requestedData: ['medical_history', 'medications', 'allergies'],
                        expiresInHours: 24
                    })
                });
                
                const data = await response.json();
                log('Access request response:', data);
                
                if (response.ok && data.success) {
                    resultDiv.className = 'step success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Access Request Sent!</h3>
                        <p><strong>Request ID:</strong> ${data.data._id}</p>
                        <p><strong>Status:</strong> ${data.data.status}</p>
                        <p><strong>Expires:</strong> ${new Date(data.data.expiresAt).toLocaleString()}</p>
                    `;
                    log('Access request sent successfully');
                } else {
                    resultDiv.className = 'step error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå Access Request Failed</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Message:</strong> ${data.message || 'Unknown error'}</p>
                    `;
                    log('Access request failed');
                }
            } catch (error) {
                resultDiv.className = 'step error';
                resultDiv.innerHTML = `<h3>‚ùå Error</h3><p>${error.message}</p>`;
                log('Error sending access request:', error);
            }
        }
        
        async function testCheckAccess() {
            if (!patientId) {
                alert('No patient ID available. Please get patients first.');
                return;
            }
            
            const resultDiv = document.getElementById('checkResult');
            resultDiv.innerHTML = 'Checking access status...';
            
            try {
                log('Checking access status for patient:', patientId);
                
                const response = await fetch(`${API_BASE}/access-control/check-access/${patientId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                log('Check access response:', data);
                
                if (response.ok && data.success) {
                    resultDiv.className = 'step success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Access Check Complete!</h3>
                        <p><strong>Has Access:</strong> ${data.data.hasAccess ? 'Yes' : 'No'}</p>
                        ${data.data.accessRequest ? `<p><strong>Access Request:</strong> ${data.data.accessRequest.status}</p>` : ''}
                    `;
                    log('Access check completed');
                } else {
                    resultDiv.className = 'step error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå Access Check Failed</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Message:</strong> ${data.message || 'Unknown error'}</p>
                    `;
                    log('Access check failed');
                }
            } catch (error) {
                resultDiv.className = 'step error';
                resultDiv.innerHTML = `<h3>‚ùå Error</h3><p>${error.message}</p>`;
                log('Error checking access:', error);
            }
        }
        
        // Auto-run login on page load
        window.onload = function() {
            log('Page loaded, ready for testing');
        };
    </script>
</body>
</html>
